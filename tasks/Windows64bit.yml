---
- name: Create 64-bit install directory (Windows x64)
  ansible.windows.win_file:
    path: "{{ auditbeat_service.install_path_windows64 }}"
    state: directory

- name: Check if auditbeat service is installed (Windows x64)
  ansible.windows.win_service:
    name: auditbeat
  register: auditbeat_installed

- name: Check if auditbeat is using current version (Windows x64)
  ansible.windows.win_stat:
    path: "{{ auditbeat_service.install_path_windows64 }}\\auditbeat-{{ auditbeat_service.version }}-windows-x86_64"
  register: auditbeat_folder

- name: Copy auditbeat uninstall script (Windows x64)
  ansible.windows.win_copy:
    src: files/uninstall-service-auditbeat.ps1
    dest: "{{ auditbeat_service.install_path_windows64 }}\\uninstall-service-auditbeat.ps1"
    force: yes
  when: auditbeat_installed.exists and not auditbeat_folder.stat.exists

- name: Uninstall auditbeat (Windows x64)
  ansible.windows.win_shell: .\uninstall-service-auditbeat.ps1
  args:
    chdir: "{{ auditbeat_service.install_path_windows64 }}"
  when: auditbeat_installed.exists and not auditbeat_folder.stat.exists

- name: Download auditbeat (Windows x64)
  ansible.windows.win_get_url:
    url: "https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-{{ auditbeat_service.version }}-windows-x86_64.zip"
    dest: "{{ auditbeat_service.install_path_windows64 }}\\auditbeat.zip"
  when: auditbeat_service.download and not auditbeat_folder.stat.exists

- name: Copy auditbeat (Windows x64)
  ansible.windows.win_copy:
    src: "files/auditbeat-{{ auditbeat_service.version }}-windows-x86_64.zip"
    dest: "{{ auditbeat_service.install_path_windows64 }}\\auditbeat.zip"
  when: not auditbeat_service.download and not auditbeat_folder.stat.exists

- name: Unzip auditbeat (Windows x64)
  community.windows.win_unzip:
    src: "{{ auditbeat_service.install_path_windows64 }}\\auditbeat.zip"
    dest: "{{ auditbeat_service.install_path_windows64 }}\\"
    delete_archive: yes
  when: not auditbeat_folder.stat.exists

- name: Configure auditbeat (Windows x64)
  ansible.windows.win_template:
    src: auditbeat-windows.yml.j2
    dest: "{{ auditbeat_service.install_path_windows64 }}\\auditbeat-{{ auditbeat_service.version }}-windows-x86_64\\auditbeat.yml"
    notify: restart-auditbeat-windows
    mode: '0755'

- name: Install auditbeat (Windows x64)
  ansible.windows.win_shell: .\install-service-auditbeat.ps1
  args:
    chdir: "{{ auditbeat_service.install_path_windows64 }}\\auditbeat-{{ auditbeat_service.version }}-windows-x86_64\\"
  when: not auditbeat_folder.stat.exists
  notify: restart-auditbeat-windows

- name: Remove other auditbeat installations (Windows x64)
  ansible.windows.win_shell: |
    $version="{{ auditbeat_service.version }}"
    Get-ChildItem -Path "{{ auditbeat_service.install_path_windows64 }}" | Where-Object {$_.Name -CNotMatch $version} | Remove-Item -Recurse
  when: not auditbeat_folder.stat.exists
